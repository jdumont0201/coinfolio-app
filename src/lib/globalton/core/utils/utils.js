"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function findById(id, list, f) {
    for (var i = 0, n = list.length; i < n; ++i) {
        var e = list[i];
        if (e._id === id) {
            f(e);
        }
    }
    return null;
}
exports.findById = findById;
function isValidEmail(value) {
    //let EMAIL_REGEXP = /^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i;
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    //console.log("test",value,",res",re.test(value));
    return re.test(value);
    //return EMAIL_REGEXP.test(value) ;
}
exports.isValidEmail = isValidEmail;
function orderByLastname(list) {
    var alphalist = "abcdefghijklmnopqrstuvwxyz";
    var contactAlphaObj = [];
    var contactOther = [];
    for (var k in list) {
        var c = list[k];
        var fl = c.lastname.substring(0, 1).toLowerCase();
        if (alphalist.indexOf(fl) > -1) {
            if (!(fl in contactAlphaObj))
                contactAlphaObj[fl] = new Array();
            contactAlphaObj[fl].push(c);
        }
        else {
            contactOther.push(c);
        }
    }
    var contactAlpha = new Array();
    Object.keys(contactAlphaObj)
        .sort()
        .forEach(function (v, i) {
        contactAlpha.push({ fl: v, contacts: contactAlphaObj[v] });
    });
    var alphaUsed = Object.keys(contactAlpha);
    return { used: alphaUsed, alpha: contactAlpha, other: contactOther };
}
exports.orderByLastname = orderByLastname;
function daysBetweenTwoDates(firstDate, secondDate) {
    var oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
    var diffDays = Math.round(Math.abs((firstDate.getTime() - secondDate.getTime()) / (oneDay)));
    if ((firstDate.getHours() * 60 + firstDate.getMinutes()) > (secondDate.getHours() * 60 + secondDate.getMinutes()))
        diffDays++;
    return diffDays;
}
exports.daysBetweenTwoDates = daysBetweenTwoDates;
function daysUpToNow(d) {
    return daysBetweenTwoDates(d, new Date());
}
exports.daysUpToNow = daysUpToNow;
var Assert = (function () {
    function Assert() {
    }
    Assert.throwError = function (msg) {
        if (typeof Error !== "undefined") {
            throw new Error(msg);
        }
        throw msg; // Fallback
    };
    Assert.exists = function (obj, message) {
        if (!obj) {
            message = message || "Exist assertion failed";
            Assert.throwError(message);
        }
    };
    Assert.isTrue = function (obj, message) {
        if (!obj) {
            message = message || "Boolean assertion failed";
            Assert.throwError(message);
        }
    };
    Assert.isString = function (obj, message) {
        var condition = (typeof obj === "string");
        var defaultMsg = "String assertion failed";
        Assert.isTrue(condition, defaultMsg);
    };
    Assert.isArray = function (obj, message) {
        var condition = (Object.prototype.toString.call(obj) === '[object Array]');
        var defaultMsg = "isArray assertion failed";
        Assert.isTrue(condition, defaultMsg);
    };
    Assert.isObject = function (obj, message) {
        var condition = (Object.prototype.toString.call(obj) === '[object Object]');
        var defaultMsg = "Object assertion failed";
        Assert.isTrue(condition, defaultMsg);
    };
    return Assert;
}());
exports.Assert = Assert;
function cloneRaw(obj) {
    //console.log("cloneRaw",obj,"type=",typeof obj,"pro=",Object.prototype.toString.call(obj));
    if ("EXTRA_FIELDS" in obj) {
        throw new Error("EXTRA_FIELDS in obj");
    }
    else {
        var res = {};
        for (var key in obj) {
            //console.log("clone key",key,obj[key]);
            var ref = obj[key];
            if (Object.prototype.toString.call(ref) === '[object Array]') {
                res[key] = [];
                for (var i = 0, n = ref.length; i < n; ++i) {
                    res[key][i] = ref[i];
                }
            }
            else if (Object.prototype.toString.call(ref) === '[object Object]') {
                res[key] = cloneRaw(ref);
            }
            else {
                res[key] = ref;
            }
        }
        //console.log("cloneRaw",obj,"to",res);
        return res;
    }
}
exports.cloneRaw = cloneRaw;
function clone(obj) {
    console.log("clone", obj);
    if (obj === null || typeof obj !== 'object') {
        return obj;
    }
    var temp = obj.constructor(); // give temp the original obj's constructor
    for (var key in obj) {
        temp[key] = clone(obj[key]);
    }
    return temp;
}
exports.clone = clone;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLGtCQUF5QixFQUFZLEVBQUUsSUFBVyxFQUFFLENBQVc7SUFDM0QsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUMxQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1QsQ0FBQztJQUNMLENBQUM7SUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFSRCw0QkFRQztBQUVELHNCQUE2QixLQUFLO0lBQzlCLHlIQUF5SDtJQUN6SCxJQUFJLEVBQUUsR0FBRyx3SkFBd0osQ0FBQztJQUNsSyxrREFBa0Q7SUFDbEQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEIsbUNBQW1DO0FBQ3ZDLENBQUM7QUFORCxvQ0FNQztBQUNELHlCQUFrQyxJQUFJO0lBQ2xDLElBQUksU0FBUyxHQUFDLDRCQUE0QixDQUFDO0lBQzNDLElBQUksZUFBZSxHQUFDLEVBQUUsQ0FBQztJQUN2QixJQUFJLFlBQVksR0FBQyxFQUFFLENBQUM7SUFDcEIsR0FBRyxDQUFBLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUEsQ0FBQztRQUNmLElBQUksQ0FBQyxHQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNkLElBQUksRUFBRSxHQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FB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QU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMxQyxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ2YsQ0FBQztJQUVELElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLDJDQUEyQztJQUN6RSxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFFaEIsQ0FBQztBQWJELHNCQWFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtPYmplY3RJZCwgUmF3fSBmcm9tICcuLi9pbnRlcmZhY2VzL2ludGVyZmFjZXMnXHJcbmltcG9ydCB7TW9kZWx9IGZyb20gXCIuLi9tb2RlbHMvTW9kZWxcIjtcclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRCeUlkKGlkOiBPYmplY3RJZCwgbGlzdDogYW55W10sIGY6IEZ1bmN0aW9uKTogYW55IHtcclxuICAgIGZvciAobGV0IGkgPSAwLCBuID0gbGlzdC5sZW5ndGg7IGkgPCBuOyArK2kpIHtcclxuICAgICAgICBsZXQgZSA9IGxpc3RbaV07XHJcbiAgICAgICAgaWYgKGUuX2lkID09PSBpZCkge1xyXG4gICAgICAgICAgICBmKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZEVtYWlsKHZhbHVlKXtcclxuICAgIC8vbGV0IEVNQUlMX1JFR0VYUCA9IC9eW2EtejAtOSEjJCUmJyorXFwvPT9eX2B7fH1+Li1dK0BbYS16MC05XShbYS16MC05LV0qW2EtejAtOV0pPyhcXC5bYS16MC05XShbYS16MC05LV0qW2EtejAtOV0pPykqJC9pO1xyXG4gICAgdmFyIHJlID0gL14oKFtePD4oKVxcW1xcXVxcXFwuLDs6XFxzQFwiXSsoXFwuW148PigpXFxbXFxdXFxcXC4sOzpcXHNAXCJdKykqKXwoXCIuK1wiKSlAKChcXFtbMC05XXsxLDN9XFwuWzAtOV17MSwzfVxcLlswLTldezEsM31cXC5bMC05XXsxLDN9XSl8KChbYS16QS1aXFwtMC05XStcXC4pK1thLXpBLVpdezIsfSkpJC87XHJcbiAgICAvL2NvbnNvbGUubG9nKFwidGVzdFwiLHZhbHVlLFwiLHJlc1wiLHJlLnRlc3QodmFsdWUpKTtcclxuICAgIHJldHVybiByZS50ZXN0KHZhbHVlKTtcclxuICAgIC8vcmV0dXJuIEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSA7XHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uICAgb3JkZXJCeUxhc3RuYW1lKGxpc3Qpe1xyXG4gICAgbGV0IGFscGhhbGlzdD1cImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6XCI7XHJcbiAgICBsZXQgY29udGFjdEFscGhhT2JqPVtdO1xyXG4gICAgbGV0IGNvbnRhY3RPdGhlcj1bXTtcclxuICAgIGZvcih2YXIgayBpbiBsaXN0KXtcclxuICAgICAgICBsZXQgYz1saXN0W2tdO1xyXG4gICAgICAgIGxldCBmbD1jLmxhc3RuYW1lLnN1YnN0cmluZygwLDEpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgaWYoYWxwaGFsaXN0LmluZGV4T2YoZmwpPi0xICl7XHJcbiAgICAgICAgICAgIGlmKCEoZmwgaW4gY29udGFjdEFscGhhT2JqKSlcclxuICAgICAgICAgICAgICAgIGNvbnRhY3RBbHBoYU9ialtmbF09bmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgIGNvbnRhY3RBbHBoYU9ialtmbF0ucHVzaChjKTtcclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgY29udGFjdE90aGVyLnB1c2goYyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgbGV0IGNvbnRhY3RBbHBoYT1uZXcgQXJyYXkoKTtcclxuICAgIE9iamVjdC5rZXlzKGNvbnRhY3RBbHBoYU9iailcclxuICAgICAgICAuc29ydCgpXHJcbiAgICAgICAgLmZvckVhY2goKHYsIGkpID0+e1xyXG4gICAgICAgICAgICBjb250YWN0QWxwaGEucHVzaCh7Zmw6dixjb250YWN0czpjb250YWN0QWxwaGFPYmpbdl19KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICBsZXQgYWxwaGFVc2VkPU9iamVjdC5rZXlzKGNvbnRhY3RBbHBoYSk7XHJcbiAgICByZXR1cm4ge3VzZWQ6YWxwaGFVc2VkLGFscGhhOmNvbnRhY3RBbHBoYSxvdGhlcjpjb250YWN0T3RoZXJ9O1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBkYXlzQmV0d2VlblR3b0RhdGVzKGZpcnN0RGF0ZTogRGF0ZSwgc2Vjb25kRGF0ZTogRGF0ZSk6IG51bWJlciB7XHJcbiAgICB2YXIgb25lRGF5ID0gMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gaG91cnMqbWludXRlcypzZWNvbmRzKm1pbGxpc2Vjb25kc1xyXG4gICAgdmFyIGRpZmZEYXlzID0gTWF0aC5yb3VuZChNYXRoLmFicygoZmlyc3REYXRlLmdldFRpbWUoKSAtIHNlY29uZERhdGUuZ2V0VGltZSgpKSAvIChvbmVEYXkpKSk7XHJcbiAgICBpZiAoKGZpcnN0RGF0ZS5nZXRIb3VycygpICogNjAgKyBmaXJzdERhdGUuZ2V0TWludXRlcygpKSA+IChzZWNvbmREYXRlLmdldEhvdXJzKCkgKiA2MCArIHNlY29uZERhdGUuZ2V0TWludXRlcygpKSkgZGlmZkRheXMrKztcclxuICAgIHJldHVybiBkaWZmRGF5cztcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gZGF5c1VwVG9Ob3coZDogRGF0ZSk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gZGF5c0JldHdlZW5Ud29EYXRlcyhkLCBuZXcgRGF0ZSgpKVxyXG59XHJcbmV4cG9ydCBjbGFzcyBBc3NlcnQge1xyXG4gICAgc3RhdGljIHRocm93RXJyb3IobXNnPzogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBFcnJvciAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhyb3cgbXNnOyAvLyBGYWxsYmFja1xyXG4gICAgfVxyXG4gICAgc3RhdGljIGV4aXN0cyhvYmo6IGFueSwgbWVzc2FnZT86IHN0cmluZykge1xyXG4gICAgICAgIGlmICghb2JqKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlIHx8IFwiRXhpc3QgYXNzZXJ0aW9uIGZhaWxlZFwiO1xyXG4gICAgICAgICAgICBBc3NlcnQudGhyb3dFcnJvcihtZXNzYWdlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgaXNUcnVlKG9iajogYm9vbGVhbiwgbWVzc2FnZT86IHN0cmluZykge1xyXG4gICAgICAgIGlmICghb2JqKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlIHx8IFwiQm9vbGVhbiBhc3NlcnRpb24gZmFpbGVkXCI7XHJcbiAgICAgICAgICAgIEFzc2VydC50aHJvd0Vycm9yKG1lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHN0YXRpYyBpc1N0cmluZyhvYmo6IGFueSwgbWVzc2FnZT86IHN0cmluZykge1xyXG4gICAgICAgIGxldCBjb25kaXRpb24gPSAodHlwZW9mIG9iaiA9PT0gXCJzdHJpbmdcIik7XHJcbiAgICAgICAgbGV0IGRlZmF1bHRNc2cgPSBcIlN0cmluZyBhc3NlcnRpb24gZmFpbGVkXCI7XHJcbiAgICAgICAgQXNzZXJ0LmlzVHJ1ZShjb25kaXRpb24sIGRlZmF1bHRNc2cpO1xyXG4gICAgfVxyXG4gICAgc3RhdGljIGlzQXJyYXkob2JqOiBhbnksIG1lc3NhZ2U/OiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgY29uZGl0aW9uID0gKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nKTtcclxuICAgICAgICBsZXQgZGVmYXVsdE1zZyA9IFwiaXNBcnJheSBhc3NlcnRpb24gZmFpbGVkXCI7XHJcbiAgICAgICAgQXNzZXJ0LmlzVHJ1ZShjb25kaXRpb24sIGRlZmF1bHRNc2cpO1xyXG4gICAgfVxyXG4gICAgc3RhdGljIGlzT2JqZWN0KG9iajogYW55LCBtZXNzYWdlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IGNvbmRpdGlvbiA9IChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgT2JqZWN0XScpO1xyXG4gICAgICAgIGxldCBkZWZhdWx0TXNnID0gXCJPYmplY3QgYXNzZXJ0aW9uIGZhaWxlZFwiO1xyXG4gICAgICAgIEFzc2VydC5pc1RydWUoY29uZGl0aW9uLCBkZWZhdWx0TXNnKTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjbG9uZVJhdyhvYmo6IFJhdyk6IFJhdyB7XHJcbiAgICAvL2NvbnNvbGUubG9nKFwiY2xvbmVSYXdcIixvYmosXCJ0eXBlPVwiLHR5cGVvZiBvYmosXCJwcm89XCIsT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpO1xyXG4gICAgaWYgKFwiRVhUUkFfRklFTERTXCIgaW4gb2JqKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRVhUUkFfRklFTERTIGluIG9ialwiKTtcclxuICAgIH0gZWxzZSB7XHJcblxyXG5cclxuICAgICAgICB2YXIgcmVzID0ge307XHJcbiAgICAgICAgZm9yIChsZXQga2V5IGluIG9iaikge1xyXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiY2xvbmUga2V5XCIsa2V5LG9ialtrZXldKTtcclxuICAgICAgICAgICAgbGV0IHJlZiA9IG9ialtrZXldO1xyXG4gICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHJlZikgPT09ICdbb2JqZWN0IEFycmF5XScpIHtcclxuICAgICAgICAgICAgICAgIHJlc1trZXldID0gW107XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbiA9IHJlZi5sZW5ndGg7IGkgPCBuOyArK2kpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNba2V5XVtpXSA9IHJlZltpXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocmVmKSA9PT0gJ1tvYmplY3QgT2JqZWN0XScpIHtcclxuICAgICAgICAgICAgICAgIHJlc1trZXldID0gY2xvbmVSYXcocmVmKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc1trZXldID0gcmVmO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcImNsb25lUmF3XCIsb2JqLFwidG9cIixyZXMpO1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xvbmUob2JqOiBSYXcpOiBSYXcge1xyXG4gICAgY29uc29sZS5sb2coXCJjbG9uZVwiLCBvYmopO1xyXG4gICAgaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIHJldHVybiBvYmo7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHRlbXAgPSBvYmouY29uc3RydWN0b3IoKTsgLy8gZ2l2ZSB0ZW1wIHRoZSBvcmlnaW5hbCBvYmoncyBjb25zdHJ1Y3RvclxyXG4gICAgZm9yICh2YXIga2V5IGluIG9iaikge1xyXG4gICAgICAgIHRlbXBba2V5XSA9IGNsb25lKG9ialtrZXldKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGVtcDtcclxuXHJcbn0iXX0=