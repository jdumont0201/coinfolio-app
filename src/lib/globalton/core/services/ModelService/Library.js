"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var model_service_1 = require("../../services/model.service");
var message_service_1 = require("../../services/message.service");
var console_service_1 = require("../../services/console.service");
var utils_1 = require("../../utils/utils");
var Library = (function () {
    function Library(modelService, consoleService, messageService) {
        this.modelService = modelService;
        this.consoleService = consoleService;
        this.messageService = messageService;
        this.isLoaded = false;
        this.library = {}; // { [key: string]: {modelType:ModelType,raw:any,model:Model}} = {};
        this.queue = {};
        this.consoleService.library("CREATE", this.modelService);
    }
    Library.prototype.isPreloaded = function () {
        return this.isLoaded;
    };
    Library.prototype.setPreloaded = function () {
        this.consoleService.library("READY", this.library);
        this.isLoaded = true;
        this.processQueue();
        this.messageService.libraryLoaded.emit({ loaded: true });
    };
    Library.prototype.processQueue = function () {
        this.consoleService.library("PROCESS QUEUE", this.queue);
        for (var id in this.queue) {
            var q = this.queue[id];
            //this.update(q.model, q.options);
            delete this.queue[id];
        }
    };
    Library.prototype.getLibrary = function () {
        return this.library;
    };
    Library.prototype.addRaw = function (raw, modelType) {
        var r = raw;
        r.modelType = modelType;
        this.library[raw._id] = r;
    };
    Library.prototype.updateField = function (id, fieldname, val) {
        this.library[id][fieldname] = val;
    };
    Library.prototype.completeUpdate = function (raw, modelType, options) {
        if (!this.isLoaded) {
            this.addToQueue(raw, options);
        }
        else {
            var id = raw._id;
            if (this.isCached(id)) {
                this.consoleService.library("completeUPDATE", raw, options);
                this.library[id] = raw;
                this.library[id].modelType = modelType;
            }
            else {
                console.log("update not cached add ", raw, "in", this.library);
                this.addRaw(raw, modelType);
            }
        }
    };
    Library.prototype.partialUpdateAll = function (raws, modelType, options) {
        for (var i = 0, n = raws.length; i < n; ++i) {
            this.partialUpdate(raws[i], modelType, options);
        }
    };
    Library.prototype.partialUpdateAllWithTimestamp = function (raws, modelType, options) {
        for (var i in raws.main) {
            this.partialUpdateWithTimestamp(raws.main[i], modelType, options);
        }
        for (var i in raws.populated) {
            this.partialUpdateWithTimestamp(raws.populated[i], modelType, options);
        }
    };
    Library.prototype.partialUpdateWithTimestamp = function (raw, modelType, options) {
        if (typeof raw === "string")
            return;
        if (!this.isLoaded) {
            this.addToQueue(raw, options);
        }
        else {
            var id = raw._id;
            if (this.isCached(id)) {
                //this.consoleService.library("partialUpdateWithTimestamp?");
                console.log("raw", raw);
                var ts = new Date(raw.updated).getTime();
                var storedts = new Date(this.library[id].updated).getTime();
                if (ts > storedts) {
                    //  this.consoleService.library("partialUpdateWithTimestamp do");
                    for (var key in raw) {
                        this.updateField(id, key, raw[key]);
                    }
                }
            }
            else {
                console.log("update not cached add ", raw, "in", this.library);
                this.addRaw(raw, modelType);
            }
        }
    };
    Library.prototype.partialUpdate = function (raw, modelType, options) {
        if (typeof raw === "string")
            return;
        if (!this.isLoaded) {
            this.addToQueue(raw, options);
        }
        else {
            var id = raw._id;
            if (this.isCached(id)) {
                this.consoleService.library("partial update", raw._id, "current=", this.library[id], "with new=", raw, options);
                for (var key in raw) {
                    this.updateField(id, key, raw[key]);
                }
            }
            else {
                console.log("update not cached add ", raw, "in", this.library);
                this.addRaw(raw, modelType);
            }
        }
    };
    Library.prototype.addToQueue = function (m, options) {
        this.consoleService.library("ADD TO QUEUE", m, options);
        this.queue[m._id] = { model: m, options: options };
    };
    Library.prototype.isCached = function (id) {
        return id in this.library;
    };
    Library.prototype.loadOneRaw = function (id, options) {
        if (this.isLoaded) {
            this.consoleService.library("LoadOne", id, (options || {}));
            var r = void 0;
            if (this.library[id]) {
                return utils_1.cloneRaw(this.library[id]); //make copy instead
            }
        }
        else {
            return null;
        }
    };
    Library.prototype.loadAllRaw = function (modelType, options) {
        if (this.isLoaded) {
            this.consoleService.library("LOAD ALL", modelType, options, this.library);
            var res = [];
            for (var id in this.library) {
                var e = this.library[id];
                if (modelType && e.modelType === modelType) {
                    res.push(this.loadOneRaw(id, options));
                }
            }
            ;
            return res;
        }
        else {
            return [];
        }
    };
    Library.prototype.getContent = function () {
        return this.library;
    };
    return Library;
}());
Library = __decorate([
    core_1.Injectable(),
    __param(0, core_1.Inject(model_service_1.ModelService)),
    __metadata("design:paramtypes", [model_service_1.ModelService,
        console_service_1.ConsoleService,
        message_service_1.MessageService])
], Library);
exports.Library = Library;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGlicmFyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkxpYnJhcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBc0U7QUFFdEUsOERBQTBEO0FBQzFELGtFQUE4RDtBQUM5RCxrRUFBOEQ7QUFFOUQsMkNBQWtEO0FBSWxELElBQWMsT0FBTztJQVFqQixpQkFBMkMsWUFBMEIsRUFDekQsY0FBOEIsRUFDOUIsY0FBOEI7UUFGQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUN6RCxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBUmxDLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFDMUIsWUFBTyxHQUFRLEVBQUUsQ0FBQyxDQUFBLG9FQUFvRTtRQUd0RixVQUFLLEdBQXNELEVBQUUsQ0FBQztRQUtsRSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCw2QkFBVyxHQUFYO1FBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDekIsQ0FBQztJQUNELDhCQUFZLEdBQVo7UUFDSSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBQ0QsOEJBQVksR0FBWjtRQUNJLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekQsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2QixrQ0FBa0M7WUFDbEMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFCLENBQUM7SUFDTCxDQUFDO0lBQ0QsNEJBQVUsR0FBVjtRQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFDRCx3QkFBTSxHQUFOLFVBQU8sR0FBUSxFQUFFLFNBQW9CO1FBQ2pDLElBQUksQ0FBQyxHQUFRLEdBQUcsQ0FBQztRQUNqQixDQUFDLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUN4QixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELDZCQUFXLEdBQVgsVUFBWSxFQUFZLEVBQUUsU0FBaUIsRUFBRSxHQUFRO1FBQ2pELElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxnQ0FBYyxHQUFkLFVBQWUsR0FBUSxFQUFDLFNBQW1CLEVBQUUsT0FBYTtRQUN0RCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksRUFBRSxHQUFhLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDM0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDNUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUM7Z0JBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxHQUFDLFNBQVMsQ0FBQztZQUN6QyxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFDOUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBQ0Qsa0NBQWdCLEdBQWhCLFVBQWlCLElBQVUsRUFBQyxTQUFtQixFQUFFLE9BQWE7UUFDMUQsR0FBRyxDQUFBLENBQUMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxJQUFJLENBQUMsTUFBTSxFQUFDLENBQUMsR0FBRyxDQUFDLEVBQUcsRUFBRSxDQUFDLEVBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBQyxTQUFTLEVBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEQsQ0FBQztJQUNMLENBQUM7SUFDRCwrQ0FBNkIsR0FBN0IsVUFBOEIsSUFBa0IsRUFBQyxTQUFtQixFQUFFLE9BQWE7UUFDL0UsR0FBRyxDQUFBLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUM7WUFDcEIsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUMsU0FBUyxFQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFDRCxHQUFHLENBQUEsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUEsQ0FBQztZQUN6QixJQUFJLENBQUMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBQyxTQUFTLEVBQUMsT0FBTyxDQUFDLENBQUM7UUFDekUsQ0FBQztJQUNMLENBQUM7SUFFRCw0Q0FBMEIsR0FBMUIsVUFBMkIsR0FBUSxFQUFDLFNBQW1CLEVBQUUsT0FBYTtRQUNsRSxFQUFFLENBQUEsQ0FBQyxPQUFPLEdBQUcsS0FBSSxRQUFRLENBQUM7WUFBQyxNQUFNLENBQUM7UUFFbEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNqQixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNsQyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQ2pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNoQiw2REFBNkQ7Z0JBQzdELE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUN2QixJQUFJLEVBQUUsR0FBUSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzlDLElBQUksUUFBUSxHQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzFELEVBQUUsQ0FBQSxDQUFDLEVBQUUsR0FBQyxRQUFRLENBQUMsQ0FBQSxDQUFDO29CQUNkLGlFQUFpRTtvQkFDL0QsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQzt3QkFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUN4QyxDQUFDO2dCQUNMLENBQUM7WUFDTixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFDOUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBRUQsK0JBQWEsR0FBYixVQUFjLEdBQVEsRUFBQyxTQUFtQixFQUFFLE9BQWE7UUFDckQsRUFBRSxDQUFBLENBQUMsT0FBTyxHQUFHLEtBQUksUUFBUSxDQUFDO1lBQUMsTUFBTSxDQUFDO1FBQ2xDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDakIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDbEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxFQUFFLEdBQWEsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUMzQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUUvRyxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNqQixJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pDLENBQUM7WUFFTCxDQUFDO1lBQUEsSUFBSSxDQUFDLENBQUM7Z0JBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFDOUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBS0QsNEJBQVUsR0FBVixVQUFXLENBQVEsRUFBRSxPQUFZO1FBQzdCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBR0QsMEJBQVEsR0FBUixVQUFTLEVBQVk7UUFDakIsTUFBTSxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQzlCLENBQUM7SUFFRCw0QkFBVSxHQUFWLFVBQTRCLEVBQVksRUFBRSxPQUFhO1FBQ25ELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM1RCxJQUFJLENBQUMsU0FBQSxDQUFDO1lBQ04sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLE1BQU0sQ0FBQyxnQkFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLG1CQUFtQjtZQUMxRCxDQUFDO1FBQ0wsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO0lBQ0wsQ0FBQztJQUVELDRCQUFVLEdBQVYsVUFBNEIsU0FBcUIsRUFBRSxPQUFhO1FBQzVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMxRSxJQUFJLEdBQUcsR0FBUSxFQUFFLENBQUM7WUFDbEIsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3pCLEVBQUUsQ0FBQyxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQ3pDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDM0MsQ0FBQztZQUNMLENBQUM7WUFBQSxDQUFDO1lBQ0YsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNmLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDZCxDQUFDO0lBRUwsQ0FBQztJQUNELDRCQUFVLEdBQVY7UUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBR0wsY0FBQztBQUFELENBQUMsQUFwS0QsSUFvS0M7QUFwS2EsT0FBTztJQURwQixpQkFBVSxFQUFFO0lBU0ssV0FBQSxhQUFNLENBQUMsNEJBQVksQ0FBQyxDQUFBO3FDQUF1Qiw0QkFBWTtRQUN6QyxnQ0FBYztRQUNkLGdDQUFjO0dBVmhDLE9BQU8sQ0FvS3BCO0FBcEthLDBCQUFPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGUsIEV2ZW50RW1pdHRlciwgT3V0cHV0fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiXHJcbmltcG9ydCB7TW9kZWx9IGZyb20gXCIuLi8uLi9tb2RlbHMvTW9kZWxcIjtcclxuaW1wb3J0IHtNb2RlbFNlcnZpY2V9IGZyb20gXCIuLi8uLi9zZXJ2aWNlcy9tb2RlbC5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7TWVzc2FnZVNlcnZpY2V9IGZyb20gXCIuLi8uLi9zZXJ2aWNlcy9tZXNzYWdlLnNlcnZpY2VcIjtcclxuaW1wb3J0IHtDb25zb2xlU2VydmljZX0gZnJvbSBcIi4uLy4uL3NlcnZpY2VzL2NvbnNvbGUuc2VydmljZVwiO1xyXG5pbXBvcnQge01vZGVsVHlwZSwgT2JqZWN0SWQsUmF3SGFzaCwgUmF3R2V0QWxsSGFzaCxSYXd9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2ludGVyZmFjZXNcIlxyXG5pbXBvcnQge2Nsb25lLCBjbG9uZVJhd30gZnJvbSBcIi4uLy4uL3V0aWxzL3V0aWxzXCI7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgIGNsYXNzIExpYnJhcnkge1xyXG5cclxuICAgIHByaXZhdGUgaXNMb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgbGlicmFyeTogYW55ID0ge307Ly8geyBba2V5OiBzdHJpbmddOiB7bW9kZWxUeXBlOk1vZGVsVHlwZSxyYXc6YW55LG1vZGVsOk1vZGVsfX0gPSB7fTtcclxuICAgIHByaXZhdGUgbWU6IGFueTtcclxuXHJcbiAgICBwcml2YXRlIHF1ZXVlOiB7IFtrZXk6IHN0cmluZ106IHsgbW9kZWw6IE1vZGVsLCBvcHRpb25zOiBhbnkgfSB9ID0ge307XHJcblxyXG4gICAgY29uc3RydWN0b3IoIEBJbmplY3QoTW9kZWxTZXJ2aWNlKSBwcml2YXRlIG1vZGVsU2VydmljZTogTW9kZWxTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgY29uc29sZVNlcnZpY2U6IENvbnNvbGVTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IE1lc3NhZ2VTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5jb25zb2xlU2VydmljZS5saWJyYXJ5KFwiQ1JFQVRFXCIsIHRoaXMubW9kZWxTZXJ2aWNlKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgaXNQcmVsb2FkZWQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNMb2FkZWQ7XHJcbiAgICB9XHJcbiAgICBzZXRQcmVsb2FkZWQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5jb25zb2xlU2VydmljZS5saWJyYXJ5KFwiUkVBRFlcIiwgdGhpcy5saWJyYXJ5KTtcclxuICAgICAgICB0aGlzLmlzTG9hZGVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnByb2Nlc3NRdWV1ZSgpO1xyXG4gICAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2UubGlicmFyeUxvYWRlZC5lbWl0KHsgbG9hZGVkOiB0cnVlIH0pO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzc1F1ZXVlKCkge1xyXG4gICAgICAgIHRoaXMuY29uc29sZVNlcnZpY2UubGlicmFyeShcIlBST0NFU1MgUVVFVUVcIiwgdGhpcy5xdWV1ZSk7XHJcbiAgICAgICAgZm9yICh2YXIgaWQgaW4gdGhpcy5xdWV1ZSkge1xyXG4gICAgICAgICAgICBsZXQgcSA9IHRoaXMucXVldWVbaWRdO1xyXG4gICAgICAgICAgICAvL3RoaXMudXBkYXRlKHEubW9kZWwsIHEub3B0aW9ucyk7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnF1ZXVlW2lkXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRMaWJyYXJ5KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxpYnJhcnk7XHJcbiAgICB9XHJcbiAgICBhZGRSYXcocmF3OiBSYXcsIG1vZGVsVHlwZTogTW9kZWxUeXBlKSB7XHJcbiAgICAgICAgbGV0IHI6IFJhdyA9IHJhdztcclxuICAgICAgICByLm1vZGVsVHlwZSA9IG1vZGVsVHlwZTtcclxuICAgICAgICB0aGlzLmxpYnJhcnlbcmF3Ll9pZF0gPSByO1xyXG4gICAgfVxyXG4gICBcclxuICAgIHVwZGF0ZUZpZWxkKGlkOiBPYmplY3RJZCwgZmllbGRuYW1lOiBzdHJpbmcsIHZhbDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5saWJyYXJ5W2lkXVtmaWVsZG5hbWVdID0gdmFsO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb21wbGV0ZVVwZGF0ZShyYXc6IFJhdyxtb2RlbFR5cGU6TW9kZWxUeXBlLCBvcHRpb25zPzogYW55KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzTG9hZGVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkVG9RdWV1ZShyYXcsIG9wdGlvbnMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBpZDogT2JqZWN0SWQgPSByYXcuX2lkO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0NhY2hlZChpZCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29uc29sZVNlcnZpY2UubGlicmFyeShcImNvbXBsZXRlVVBEQVRFXCIsIHJhdywgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxpYnJhcnlbaWRdID0gcmF3O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5saWJyYXJ5W2lkXS5tb2RlbFR5cGU9bW9kZWxUeXBlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1cGRhdGUgbm90IGNhY2hlZCBhZGQgXCIsIHJhdywgXCJpblwiLCB0aGlzLmxpYnJhcnkpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZFJhdyhyYXcsbW9kZWxUeXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHBhcnRpYWxVcGRhdGVBbGwocmF3czpSYXdbXSxtb2RlbFR5cGU6TW9kZWxUeXBlLCBvcHRpb25zPzogYW55KSB7XHJcbiAgICAgICAgZm9yKHZhciBpPTAsIG49cmF3cy5sZW5ndGg7aSA8IG4gOyArK2kpe1xyXG4gICAgICAgICAgICB0aGlzLnBhcnRpYWxVcGRhdGUocmF3c1tpXSxtb2RlbFR5cGUsb3B0aW9ucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcGFydGlhbFVwZGF0ZUFsbFdpdGhUaW1lc3RhbXAocmF3czpSYXdHZXRBbGxIYXNoLG1vZGVsVHlwZTpNb2RlbFR5cGUsIG9wdGlvbnM/OiBhbnkpIHtcclxuICAgICAgICBmb3IodmFyIGkgaW4gcmF3cy5tYWluKXtcclxuICAgICAgICAgICAgdGhpcy5wYXJ0aWFsVXBkYXRlV2l0aFRpbWVzdGFtcChyYXdzLm1haW5baV0sbW9kZWxUeXBlLG9wdGlvbnMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IodmFyIGkgaW4gcmF3cy5wb3B1bGF0ZWQpe1xyXG4gICAgICAgICAgICB0aGlzLnBhcnRpYWxVcGRhdGVXaXRoVGltZXN0YW1wKHJhd3MucG9wdWxhdGVkW2ldLG1vZGVsVHlwZSxvcHRpb25zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHBhcnRpYWxVcGRhdGVXaXRoVGltZXN0YW1wKHJhdzogUmF3LG1vZGVsVHlwZTpNb2RlbFR5cGUsIG9wdGlvbnM/OiBhbnkpOnZvaWQge1xyXG4gICAgICAgIGlmKHR5cGVvZiByYXcgPT09XCJzdHJpbmdcIikgcmV0dXJuO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghdGhpcy5pc0xvYWRlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFRvUXVldWUocmF3LCBvcHRpb25zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgaWQgPSByYXcuX2lkO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0NhY2hlZChpZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL3RoaXMuY29uc29sZVNlcnZpY2UubGlicmFyeShcInBhcnRpYWxVcGRhdGVXaXRoVGltZXN0YW1wP1wiKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInJhd1wiLHJhdyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRzOm51bWJlcj1uZXcgRGF0ZShyYXcudXBkYXRlZCkuZ2V0VGltZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdG9yZWR0cz1uZXcgRGF0ZSh0aGlzLmxpYnJhcnlbaWRdLnVwZGF0ZWQpLmdldFRpbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZih0cz5zdG9yZWR0cyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAvLyAgdGhpcy5jb25zb2xlU2VydmljZS5saWJyYXJ5KFwicGFydGlhbFVwZGF0ZVdpdGhUaW1lc3RhbXAgZG9cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGtleSBpbiByYXcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRmllbGQoaWQsIGtleSwgcmF3W2tleV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1cGRhdGUgbm90IGNhY2hlZCBhZGQgXCIsIHJhdywgXCJpblwiLCB0aGlzLmxpYnJhcnkpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZFJhdyhyYXcsbW9kZWxUeXBlKTtcclxuICAgICAgICAgICAgfSAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwYXJ0aWFsVXBkYXRlKHJhdzogUmF3LG1vZGVsVHlwZTpNb2RlbFR5cGUsIG9wdGlvbnM/OiBhbnkpIHtcclxuICAgICAgICBpZih0eXBlb2YgcmF3ID09PVwic3RyaW5nXCIpIHJldHVybjtcclxuICAgICAgICBpZiAoIXRoaXMuaXNMb2FkZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRUb1F1ZXVlKHJhdywgb3B0aW9ucyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IGlkOiBPYmplY3RJZCA9IHJhdy5faWQ7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlzQ2FjaGVkKGlkKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb25zb2xlU2VydmljZS5saWJyYXJ5KFwicGFydGlhbCB1cGRhdGVcIiwgcmF3Ll9pZCwgXCJjdXJyZW50PVwiLHRoaXMubGlicmFyeVtpZF0sIFwid2l0aCBuZXc9XCIsIHJhdywgb3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHJhdykge1xyXG4gICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZpZWxkKGlkLCBrZXksIHJhd1trZXldKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInVwZGF0ZSBub3QgY2FjaGVkIGFkZCBcIiwgcmF3LCBcImluXCIsIHRoaXMubGlicmFyeSlcclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkUmF3KHJhdyxtb2RlbFR5cGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgICAgXHJcbiAgICAgICAgXHJcblxyXG4gICAgXHJcbiAgICBhZGRUb1F1ZXVlKG06IE1vZGVsLCBvcHRpb25zOiBhbnkpIHtcclxuICAgICAgICB0aGlzLmNvbnNvbGVTZXJ2aWNlLmxpYnJhcnkoXCJBREQgVE8gUVVFVUVcIiwgbSwgb3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5xdWV1ZVttLl9pZF0gPSB7IG1vZGVsOiBtLCBvcHRpb25zOiBvcHRpb25zIH07XHJcbiAgICB9XHJcbiAgXHJcblxyXG4gICAgaXNDYWNoZWQoaWQ6IE9iamVjdElkKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGlkIGluIHRoaXMubGlicmFyeTtcclxuICAgIH1cclxuICBcclxuICAgIGxvYWRPbmVSYXc8VCBleHRlbmRzIE1vZGVsPihpZDogT2JqZWN0SWQsIG9wdGlvbnM/OiBhbnkpOiBSYXcge1xyXG4gICAgICAgIGlmICh0aGlzLmlzTG9hZGVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29uc29sZVNlcnZpY2UubGlicmFyeShcIkxvYWRPbmVcIiwgaWQsIChvcHRpb25zIHx8IHt9KSk7XHJcbiAgICAgICAgICAgIGxldCByO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5saWJyYXJ5W2lkXSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsb25lUmF3KHRoaXMubGlicmFyeVtpZF0pOyAvL21ha2UgY29weSBpbnN0ZWFkXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbG9hZEFsbFJhdzxUIGV4dGVuZHMgTW9kZWw+KG1vZGVsVHlwZT86IE1vZGVsVHlwZSwgb3B0aW9ucz86IGFueSk6IFRbXXtcclxuICAgICAgICBpZiAodGhpcy5pc0xvYWRlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnNvbGVTZXJ2aWNlLmxpYnJhcnkoXCJMT0FEIEFMTFwiLCBtb2RlbFR5cGUsIG9wdGlvbnMsIHRoaXMubGlicmFyeSk7XHJcbiAgICAgICAgICAgIGxldCByZXM6IFRbXSA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpZCBpbiB0aGlzLmxpYnJhcnkpIHtcclxuICAgICAgICAgICAgICAgIGxldCBlID0gdGhpcy5saWJyYXJ5W2lkXTtcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbFR5cGUgJiYgZS5tb2RlbFR5cGUgPT09IG1vZGVsVHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKHRoaXMubG9hZE9uZVJhdyhpZCwgb3B0aW9ucykpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG4gICAgZ2V0Q29udGVudCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5saWJyYXJ5O1xyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuIl19