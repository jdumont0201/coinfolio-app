"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var GenericDataAdapter = (function () {
    function GenericDataAdapter() {
        this.POPULABLE_SINGLE_FIELDS = {};
        this.POPULABLE_ARRAY_FIELDS = {};
        this.POPULABLE_INNER_ARRAY_FIELD = {};
    }
    /**
     * Returns the string version of the model
     * @method serialize
     * @returns {string} the serialized version of the data fields for this object
     */
    GenericDataAdapter.prototype.serialize = function (obj) {
        return JSON.stringify(obj.getFields());
    };
    /**
     * Returns the string version of the modified fields of the model
     * @method serialize
     * @returns {string} the serialized version of the data fields for this object
     */
    GenericDataAdapter.prototype.serializeModified = function (obj, referenceRaw) {
        return JSON.stringify(obj.getModifiedFields(referenceRaw));
    };
    GenericDataAdapter.prototype.isPopulableField = function (name) {
        return name in this.POPULABLE_SINGLE_FIELDS;
    };
    GenericDataAdapter.prototype.isPopulableArrayField = function (name) {
        return name in this.POPULABLE_ARRAY_FIELDS;
    };
    GenericDataAdapter.prototype.isPopulableInnerArrayField = function (name) {
        return name in this.POPULABLE_INNER_ARRAY_FIELD;
    };
    GenericDataAdapter.prototype.isPopulated = function (obj, value) {
        console.log("    val", value, typeof value);
        return !(typeof value === "string" || typeof value === "number" || typeof value === "boolean");
    };
    GenericDataAdapter.prototype.getPopulatedItem = function (obj, key) {
        if (key in this.POPULABLE_SINGLE_FIELDS) {
            if (obj[key])
                return obj[key].getObject();
            else {
                console.warn("this", key, "not set");
            }
        }
        else {
            console.error("Getpopulated on not populated prop", key, "val=", this[key]);
            return null;
        }
    };
    GenericDataAdapter.prototype.getPopulatedArray = function (obj, key) {
        console.log("GETPOPULATED");
        if (key in this.POPULABLE_ARRAY_FIELDS) {
            if (obj[key]) {
                var res_1 = [];
                obj[key].forEach(function (e, index, array) { res_1.push(e.getObject()); });
                return res_1;
            }
            else {
                console.warn("this", key, "not set");
            }
        }
        else {
            console.error("Getpopulated on not populated prop", key, "val=", this[key]);
            return [];
        }
    };
    /*
     Returns the raw value of the field fieldName of the current model
     In particular, extracts the value from Populated objects.
     */
    GenericDataAdapter.prototype.getField = function (obj, fieldName) {
        var fieldValue = obj[fieldName];
        if (!fieldValue)
            return null;
        if (this.isPopulableField(fieldName)) {
            var fieldValue_1 = obj[fieldName];
            if (typeof fieldValue_1 === "string")
                return fieldValue_1;
            else
                return fieldValue_1.getObjectId();
        }
        else if (this.isPopulableArrayField(fieldName)) {
            var fieldValue_2 = obj[fieldName];
            if (fieldValue_2.length == 0)
                return [];
            var re = [];
            for (var j = 0, m = fieldValue_2.length; j < m; ++j) {
                var oid = fieldValue_2[j].getObjectId();
                if (oid)
                    re.push(oid);
            }
            return re;
        }
        else if (this.isPopulableInnerArrayField(fieldName)) {
            //TODO
        }
        else {
            if (Object.prototype.toString.call(fieldValue) === '[object Array]') {
                return JSON.parse(JSON.stringify(fieldValue));
            }
            else {
                return fieldValue;
            }
        }
    };
    /*
     Returns the raw unpopulated object of the current model
     */
    GenericDataAdapter.prototype.getFields = function (obj, useExtra) {
        var fieldSet = {};
        for (var i = 0, n = obj.datafields.length; i < n; ++i) {
            var fieldName = obj.datafields[i];
            if (obj[fieldName]) {
                fieldSet[fieldName] = obj.getField(fieldName);
            }
        }
        if (useExtra) {
            for (var i = 0, n = obj.EXTRA_FIELDS.length; i < n; ++i) {
                var fieldName = obj.EXTRA_FIELDS[i];
                if (obj[fieldName]) {
                    fieldSet[fieldName] = obj.getField(fieldName);
                }
            }
        }
        fieldSet["record"] = obj.record;
        fieldSet["modelType"] = obj.modelType;
        return fieldSet;
    };
    /*
     Check if the value if modified from the reference value from the db (typically, comes from the Library)
     returns true if val1 is different from val2
     */
    GenericDataAdapter.prototype.isFieldModified = function (obj, old, neu) {
        console.log("    compare ", old, neu);
        if (typeof old === 'undefined' && typeof neu === 'undefined') {
            console.log("    null compa");
            return false;
        }
        if ((typeof old === 'undefined' && (typeof neu !== 'undefined')) || (typeof neu === 'undefined' && typeof old !== 'undefined')) {
            console.log("    is oe null");
            return true;
        }
        if (typeof old === "string" || typeof old === "number" || typeof old === "boolean") {
            console.log("    string compa", old, neu, old !== neu);
            return old !== neu;
        }
        else {
            console.log("    obj array compa");
            if (Object.prototype.toString.call(old) === '[object Object]') {
                for (var i in neu) {
                    var isModified = obj.isFieldModified(old[i], neu[i]);
                    if (isModified)
                        return true;
                }
                return false;
            }
            else if (Object.prototype.toString.call(old) === '[object Array]') {
                return old.toString() !== neu.toString();
            }
            else {
                return !((old.length == neu.length) && old.every(function (element, index) { return element === neu[index]; }));
            }
        }
    };
    /*
     Returns true if the current model has a different field compared to the reference object (typicall, stored in the library)
     */
    GenericDataAdapter.prototype.isModified = function (obj, fieldName, ref, cur) {
        if (!ref)
            return true;
        if (!(fieldName in ref) && (fieldName in cur))
            return true;
        var old = ref[fieldName];
        var val = cur[fieldName];
        console.log("    model isModified compare field=", fieldName, ": old=", old, "new=", val);
        var res = obj.isFieldModified(old, val);
        console.log(res, typeof old, typeof val);
        return res;
    };
    /*
     Returns a raw unhydrated copy of the model, with only modified fields
     */
    GenericDataAdapter.prototype.getModifiedFields = function (obj, ref) {
        console.log("    model getModifiedFields", ref, this);
        var cur = obj.getFields();
        var modified = {};
        for (var i = 0, n = obj.datafields.length; i < n; ++i) {
            var fieldName = obj.datafields[i];
            if (obj.isModified(fieldName, ref, cur)) {
                modified[fieldName] = cur[fieldName];
            }
        }
        console.log("    model getModifiedFields=", modified);
        return modified;
    };
    return GenericDataAdapter;
}());
exports.GenericDataAdapter = GenericDataAdapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2VuZXJpY0RhdGFBZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiR2VuZXJpY0RhdGFBZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBSUE7SUFFSTtRQUdBLDRCQUF1QixHQUFLLEVBQUUsQ0FBQztRQUMvQiwyQkFBc0IsR0FBSyxFQUFFLENBQUM7UUFDOUIsZ0NBQTJCLEdBQUssRUFBRSxDQUFDO0lBSG5DLENBQUM7SUFTRDs7OztPQUlHO0lBQ0gsc0NBQVMsR0FBVCxVQUFVLEdBQVM7UUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNILDhDQUFpQixHQUFqQixVQUFrQixHQUFTLEVBQUMsWUFBaUI7UUFDekMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVELDZDQUFnQixHQUFoQixVQUFpQixJQUFZO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLHVCQUF1QixDQUFDO0lBQ2pELENBQUM7SUFDRCxrREFBcUIsR0FBckIsVUFBc0IsSUFBWTtRQUU5QixNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztJQUMvQyxDQUFDO0lBQ0QsdURBQTBCLEdBQTFCLFVBQTJCLElBQVk7UUFFbkMsTUFBTSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsMkJBQTJCLENBQUM7SUFDcEQsQ0FBQztJQUNELHdDQUFXLEdBQVgsVUFBWSxHQUFTLEVBQUMsS0FBVTtRQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsT0FBTyxLQUFLLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxP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a0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZGVsfSBmcm9tIFwiLi4vLi4vbW9kZWxzL01vZGVsXCJcclxuaW1wb3J0IHtPYmplY3RJZCwgTW9kZWxUeXBlLFBvcHVsYWJsZUl0ZW0sTW9kZWxDYWxsYmFjayxSYXcsIERhdGFJbnRlcmZhY2V9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2ludGVyZmFjZXNcIlxyXG5cclxuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBHZW5lcmljRGF0YUFkYXB0ZXIgaW1wbGVtZW50cyBEYXRhSW50ZXJmYWNlIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuXHJcbiAgICB9XHJcbiAgICBQT1BVTEFCTEVfU0lOR0xFX0ZJRUxEUzphbnk9e307XHJcbiAgICBQT1BVTEFCTEVfQVJSQVlfRklFTERTOmFueT17fTtcclxuICAgIFBPUFVMQUJMRV9JTk5FUl9BUlJBWV9GSUVMRDphbnk9e307XHJcbiAgICBhYnN0cmFjdCBzYXZlPFQ+KG9iajpNb2RlbCxmOkZ1bmN0aW9uKTtcclxuICAgIGFic3RyYWN0IGNyeXB0KHA6c3RyaW5nKTtcclxuICAgIGFic3RyYWN0IGZpbmRPbmUobW9kZWxUeXBlOk1vZGVsVHlwZSxjcml0OmFueSk6UHJvbWlzZTxNb2RlbD47XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJucyB0aGUgc3RyaW5nIHZlcnNpb24gb2YgdGhlIG1vZGVsXHJcbiAgICAgKiBAbWV0aG9kIHNlcmlhbGl6ZVxyXG4gICAgICogQHJldHVybnMge3N0cmluZ30gdGhlIHNlcmlhbGl6ZWQgdmVyc2lvbiBvZiB0aGUgZGF0YSBmaWVsZHMgZm9yIHRoaXMgb2JqZWN0XHJcbiAgICAgKi9cclxuICAgIHNlcmlhbGl6ZShvYmo6TW9kZWwpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmouZ2V0RmllbGRzKCkpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXR1cm5zIHRoZSBzdHJpbmcgdmVyc2lvbiBvZiB0aGUgbW9kaWZpZWQgZmllbGRzIG9mIHRoZSBtb2RlbFxyXG4gICAgICogQG1ldGhvZCBzZXJpYWxpemVcclxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHRoZSBzZXJpYWxpemVkIHZlcnNpb24gb2YgdGhlIGRhdGEgZmllbGRzIGZvciB0aGlzIG9iamVjdFxyXG4gICAgICovXHJcbiAgICBzZXJpYWxpemVNb2RpZmllZChvYmo6TW9kZWwscmVmZXJlbmNlUmF3OiBSYXcpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmouZ2V0TW9kaWZpZWRGaWVsZHMocmVmZXJlbmNlUmF3KSk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNQb3B1bGFibGVGaWVsZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5QT1BVTEFCTEVfU0lOR0xFX0ZJRUxEUztcclxuICAgIH1cclxuICAgIGlzUG9wdWxhYmxlQXJyYXlGaWVsZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5QT1BVTEFCTEVfQVJSQVlfRklFTERTO1xyXG4gICAgfVxyXG4gICAgaXNQb3B1bGFibGVJbm5lckFycmF5RmllbGQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcblxyXG4gICAgICAgIHJldHVybiBuYW1lIGluIHRoaXMuUE9QVUxBQkxFX0lOTkVSX0FSUkFZX0ZJRUxEO1xyXG4gICAgfVxyXG4gICAgaXNQb3B1bGF0ZWQob2JqOk1vZGVsLHZhbHVlOiBhbnkpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIiAgICB2YWxcIiwgdmFsdWUsIHR5cGVvZiB2YWx1ZSk7XHJcbiAgICAgICAgcmV0dXJuICEodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gXCJudW1iZXJcIiB8fCB0eXBlb2YgdmFsdWUgPT09IFwiYm9vbGVhblwiKVxyXG4gICAgfVxyXG4gICAgZ2V0UG9wdWxhdGVkSXRlbShvYmo6TW9kZWwsa2V5OnN0cmluZyk6UG9wdWxhYmxlSXRlbTxhbnk+e1xyXG4gICAgICAgIGlmKGtleSBpbiB0aGlzLlBPUFVMQUJMRV9TSU5HTEVfRklFTERTKXtcclxuICAgICAgICAgICAgaWYob2JqW2tleV0pXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gPFBvcHVsYWJsZUl0ZW08YW55Pj5vYmpba2V5XS5nZXRPYmplY3QoKTtcclxuICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcInRoaXNcIixrZXksXCJub3Qgc2V0XCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJHZXRwb3B1bGF0ZWQgb24gbm90IHBvcHVsYXRlZCBwcm9wXCIsa2V5LFwidmFsPVwiLHRoaXNba2V5XSk7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0UG9wdWxhdGVkQXJyYXkob2JqOk1vZGVsLGtleTpzdHJpbmcpOlBvcHVsYWJsZUl0ZW08YW55Pltde1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiR0VUUE9QVUxBVEVEXCIpO1xyXG4gICAgICAgIGlmKGtleSBpbiB0aGlzLlBPUFVMQUJMRV9BUlJBWV9GSUVMRFMpe1xyXG4gICAgICAgICAgICBpZihvYmpba2V5XSl7XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVzPVtdO1xyXG4gICAgICAgICAgICAgICAgb2JqW2tleV0uZm9yRWFjaCgoZTpQb3B1bGFibGVJdGVtPGFueT4saW5kZXgsYXJyYXkpPT57cmVzLnB1c2goZS5nZXRPYmplY3QoKSl9KVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJ0aGlzXCIsa2V5LFwibm90IHNldFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiR2V0cG9wdWxhdGVkIG9uIG5vdCBwb3B1bGF0ZWQgcHJvcFwiLGtleSxcInZhbD1cIix0aGlzW2tleV0pO1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLypcclxuICAgICBSZXR1cm5zIHRoZSByYXcgdmFsdWUgb2YgdGhlIGZpZWxkIGZpZWxkTmFtZSBvZiB0aGUgY3VycmVudCBtb2RlbFxyXG4gICAgIEluIHBhcnRpY3VsYXIsIGV4dHJhY3RzIHRoZSB2YWx1ZSBmcm9tIFBvcHVsYXRlZCBvYmplY3RzLlxyXG4gICAgICovXHJcbiAgICBnZXRGaWVsZChvYmo6TW9kZWwsZmllbGROYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgZmllbGRWYWx1ZSA9IG9ialtmaWVsZE5hbWVdO1xyXG4gICAgICAgIGlmICghZmllbGRWYWx1ZSkgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNQb3B1bGFibGVGaWVsZChmaWVsZE5hbWUpKSB7XHJcbiAgICAgICAgICAgIGxldCBmaWVsZFZhbHVlOiBQb3B1bGFibGVJdGVtPGFueT4gPSBvYmpbZmllbGROYW1lXTtcclxuICAgICAgICAgICAgaWYodHlwZW9mIGZpZWxkVmFsdWU9PT1cInN0cmluZ1wiKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkVmFsdWU7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZFZhbHVlLmdldE9iamVjdElkKCk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzUG9wdWxhYmxlQXJyYXlGaWVsZChmaWVsZE5hbWUpKSB7XHJcbiAgICAgICAgICAgIGxldCBmaWVsZFZhbHVlOlBvcHVsYWJsZUl0ZW08YW55PltdID0gb2JqW2ZpZWxkTmFtZV07XHJcbiAgICAgICAgICAgIGlmIChmaWVsZFZhbHVlLmxlbmd0aCA9PSAwKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG5cclxuICAgICAgICAgICAgbGV0IHJlID0gW107XHJcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBtID0gZmllbGRWYWx1ZS5sZW5ndGg7IGogPCBtOyArK2opIHtcclxuICAgICAgICAgICAgICAgIGxldCBvaWQgPSBmaWVsZFZhbHVlW2pdLmdldE9iamVjdElkKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAob2lkKVxyXG4gICAgICAgICAgICAgICAgICAgIHJlLnB1c2gob2lkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmU7XHJcbiAgICAgICAgfWVsc2UgaWYodGhpcy5pc1BvcHVsYWJsZUlubmVyQXJyYXlGaWVsZChmaWVsZE5hbWUpKXtcclxuICAgICAgICAgICAgICAgIC8vVE9ET1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZmllbGRWYWx1ZSkgPT09ICdbb2JqZWN0IEFycmF5XScpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGZpZWxkVmFsdWUpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZFZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLypcclxuICAgICBSZXR1cm5zIHRoZSByYXcgdW5wb3B1bGF0ZWQgb2JqZWN0IG9mIHRoZSBjdXJyZW50IG1vZGVsXHJcbiAgICAgKi9cclxuICAgIGdldEZpZWxkcyhvYmo6TW9kZWwsdXNlRXh0cmE/OiBib29sZWFuKTogUmF3IHtcclxuICAgICAgICB2YXIgZmllbGRTZXQgPSB7fTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbiA9IG9iai5kYXRhZmllbGRzLmxlbmd0aDsgaSA8IG47ICsraSkge1xyXG4gICAgICAgICAgICBsZXQgZmllbGROYW1lOiBzdHJpbmcgPSBvYmouZGF0YWZpZWxkc1tpXTtcclxuICAgICAgICAgICAgaWYgKG9ialtmaWVsZE5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICBmaWVsZFNldFtmaWVsZE5hbWVdID0gb2JqLmdldEZpZWxkKGZpZWxkTmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh1c2VFeHRyYSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbiA9IG9iai5FWFRSQV9GSUVMRFMubGVuZ3RoOyBpIDwgbjsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmllbGROYW1lOiBzdHJpbmcgPSBvYmouRVhUUkFfRklFTERTW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9ialtmaWVsZE5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmllbGRTZXRbZmllbGROYW1lXSA9IG9iai5nZXRGaWVsZChmaWVsZE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBmaWVsZFNldFtcInJlY29yZFwiXT1vYmoucmVjb3JkO1xyXG4gICAgICAgIGZpZWxkU2V0W1wibW9kZWxUeXBlXCJdPW9iai5tb2RlbFR5cGU7XHJcbiAgICAgICAgcmV0dXJuIGZpZWxkU2V0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qXHJcbiAgICAgQ2hlY2sgaWYgdGhlIHZhbHVlIGlmIG1vZGlmaWVkIGZyb20gdGhlIHJlZmVyZW5jZSB2YWx1ZSBmcm9tIHRoZSBkYiAodHlwaWNhbGx5LCBjb21lcyBmcm9tIHRoZSBMaWJyYXJ5KVxyXG4gICAgIHJldHVybnMgdHJ1ZSBpZiB2YWwxIGlzIGRpZmZlcmVudCBmcm9tIHZhbDJcclxuICAgICAqL1xyXG4gICAgaXNGaWVsZE1vZGlmaWVkKG9iajpNb2RlbCxvbGQ6IGFueSwgbmV1OiBhbnkpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIiAgICBjb21wYXJlIFwiLCBvbGQsIG5ldSk7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBvbGQgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBuZXUgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiICAgIG51bGwgY29tcGFcIik7IHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCh0eXBlb2Ygb2xkID09PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mIG5ldSAhPT0gJ3VuZGVmaW5lZCcpKSB8fCAodHlwZW9mIG5ldSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIG9sZCAhPT0gJ3VuZGVmaW5lZCcpKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiICAgIGlzIG9lIG51bGxcIik7IHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIG9sZCA9PT0gXCJzdHJpbmdcIiB8fCB0eXBlb2Ygb2xkID09PSBcIm51bWJlclwiIHx8IHR5cGVvZiBvbGQgPT09IFwiYm9vbGVhblwiKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiICAgIHN0cmluZyBjb21wYVwiLCBvbGQsIG5ldSwgb2xkICE9PSBuZXUpXHJcbiAgICAgICAgICAgIHJldHVybiBvbGQgIT09IG5ldTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIiAgICBvYmogYXJyYXkgY29tcGFcIilcclxuICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvbGQpID09PSAnW29iamVjdCBPYmplY3RdJykgeyAvL2lmIHBvcHVsYXRlZFxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSBpbiBuZXUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgaXNNb2RpZmllZCA9IG9iai5pc0ZpZWxkTW9kaWZpZWQob2xkW2ldLCBuZXVbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc01vZGlmaWVkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2xkKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgeyAvL2lmIHBvcHVsYXRlZFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9sZC50b1N0cmluZygpICE9PSBuZXUudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gISgob2xkLmxlbmd0aCA9PSBuZXUubGVuZ3RoKSAmJiBvbGQuZXZlcnkoZnVuY3Rpb24oZWxlbWVudCwgaW5kZXgpIHsgcmV0dXJuIGVsZW1lbnQgPT09IG5ldVtpbmRleF07IH0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qXHJcbiAgICAgUmV0dXJucyB0cnVlIGlmIHRoZSBjdXJyZW50IG1vZGVsIGhhcyBhIGRpZmZlcmVudCBmaWVsZCBjb21wYXJlZCB0byB0aGUgcmVmZXJlbmNlIG9iamVjdCAodHlwaWNhbGwsIHN0b3JlZCBpbiB0aGUgbGlicmFyeSlcclxuICAgICAqL1xyXG4gICAgaXNNb2RpZmllZChvYmo6TW9kZWwsZmllbGROYW1lOiBzdHJpbmcsIHJlZjogUmF3LCBjdXI6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghcmVmKSByZXR1cm4gdHJ1ZTtcclxuICAgICAgICBpZiAoIShmaWVsZE5hbWUgaW4gcmVmKSAmJiAoZmllbGROYW1lIGluIGN1cikpIHJldHVybiB0cnVlO1xyXG4gICAgICAgIGxldCBvbGQgPSByZWZbZmllbGROYW1lXTtcclxuICAgICAgICBsZXQgdmFsID0gY3VyW2ZpZWxkTmFtZV07XHJcbiAgICAgICAgY29uc29sZS5sb2coXCIgICAgbW9kZWwgaXNNb2RpZmllZCBjb21wYXJlIGZpZWxkPVwiLCBmaWVsZE5hbWUsIFwiOiBvbGQ9XCIsIG9sZCwgXCJuZXc9XCIsIHZhbCk7XHJcbiAgICAgICAgbGV0IHJlcyA9IG9iai5pc0ZpZWxkTW9kaWZpZWQob2xkLCB2YWwpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHJlcywgdHlwZW9mIG9sZCwgdHlwZW9mIHZhbCk7XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH1cclxuICAgIC8qXHJcbiAgICAgUmV0dXJucyBhIHJhdyB1bmh5ZHJhdGVkIGNvcHkgb2YgdGhlIG1vZGVsLCB3aXRoIG9ubHkgbW9kaWZpZWQgZmllbGRzXHJcbiAgICAgKi9cclxuICAgIGdldE1vZGlmaWVkRmllbGRzKG9iajpNb2RlbCxyZWY6IFJhdyk6IFJhdyB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCIgICAgbW9kZWwgZ2V0TW9kaWZpZWRGaWVsZHNcIiwgcmVmLCB0aGlzKTtcclxuICAgICAgICBsZXQgY3VyID0gb2JqLmdldEZpZWxkcygpO1xyXG4gICAgICAgIGxldCBtb2RpZmllZCA9IHt9O1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gb2JqLmRhdGFmaWVsZHMubGVuZ3RoOyBpIDwgbjsgKytpKSB7XHJcbiAgICAgICAgICAgIGxldCBmaWVsZE5hbWU6IHN0cmluZyA9IG9iai5kYXRhZmllbGRzW2ldO1xyXG4gICAgICAgICAgICBpZiAob2JqLmlzTW9kaWZpZWQoZmllbGROYW1lLCByZWYsIGN1cikpIHtcclxuICAgICAgICAgICAgICAgIG1vZGlmaWVkW2ZpZWxkTmFtZV0gPSBjdXJbZmllbGROYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zb2xlLmxvZyhcIiAgICBtb2RlbCBnZXRNb2RpZmllZEZpZWxkcz1cIiwgbW9kaWZpZWQpO1xyXG4gICAgICAgIHJldHVybiBtb2RpZmllZDtcclxuICAgIH1cclxuXHJcbn0iXX0=